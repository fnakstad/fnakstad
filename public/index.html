
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A Modest Proposal</title>
  <meta name="author" content="Frederik Nakstad">

  
  <meta name="description" content="As you may have gathered from the title, this is a follow-up to a post I wrote a some time ago regarding role-based authentication/authorization in &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://frederiknakstad.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="A Modest Proposal" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Yellowtail&amp;ver=1.0.8" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,700' rel='stylesheet' type='text/css'>
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37251205-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">A Modest Proposal</a></h1>
  
    <h2>Web Development, Japanese, Music.</h2>
  
</hgroup>

</header>
  <nav role="navigation">
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

<ul class="social-icons">
	
	<li>
		<a href="http://github.com/fnakstad">
			<i class="icon-github"></i>
		</a>
	</li>
	
	
	<li>
		<a href="http://www.linkedin.com/in/frederiknakstad">
			<i class="icon-linkedin"></i>
		</a>
	</li>
	
	
	<li>
		<a href="http://twitter.com/fnakstad">
			<i class="icon-twitter"></i>
		</a>
	</li>
	
	
	<li>
		<a href="/atom.xml">
			<i class="icon-rss"></i>
		</a>
	</li>
	
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/04/authentication-in-single-page-applications-with-angular.js-part-2/">Authentication in Single Page Applications With Angular.js Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-04T00:00:00+02:00" pubdate data-updated="true">Aug 4<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/08/04/authentication-in-single-page-applications-with-angular.js-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As you may have gathered from the title, this is a follow-up to <a href="http://www.frederiknakstad.com/authentication-in-single-page-applications-with-angular-js/">a post I wrote a some time ago</a> regarding role-based authentication/authorization in single page applications. This time I&rsquo;d like to highlight how I implemented routing and authorization in the Node.js server that complements my Angular client.</p>

<p><strong>Since you can never trust that the client code hasn’t been tampered with by the user, it’s paramount to have a good authentication/authorization strategy on the server. The client-side auth scheme I introduced earlier is simply a convenient way to customize the user interface – proper authentication/authorization should always be left up to the server-side.</strong></p>

<p>I am using Node.js/Express along with the excellent Passport.js authentication middleware, but hopefully it shouldn&rsquo;t be too much bother to apply the same patterns to other server-side frameworks. You can see an example of this scheme implemented in <a href="https://github.com/fnakstad/angular-client-side-auth">this GitHub repo</a>, and I have a live version of it <a href="http://angular-client-side-auth.herokuapp.com/">running on Heroku</a>.</p>

<p>Well, let&rsquo;s get right to it!</p>

<h2>Project layout</h2>

<p>Node.js/Express is very non-prescriptive in terms of dictating how to lay out your code, so I’ll try to give a quick overview how I structure my projects first. When working with Node.js/Angular I usually divide my code into server and client directories, and then split my server side code into controllers and models. So my directory structure will look something like this:</p>

<p><img src="/images/posts/2013-08-04-authentication-in-single-page-applications-with-angular.js-part-2/project_layout.png"></p>

<p>The <strong>client</strong> directory contains all my client-side Javascript (including all my Angular.js code), HTML, and CSS resources. This is because I want a clear division between the resources that will be running in the browser and those that will be run server-side. The client folder is served as a static directory structure by Node.js. My <strong>server</strong> directory contains the code for defining my REST API. So, when the client has been downloaded in the user’s browser it will communicate with the server by sending XHRs to fetch data, login/logout users, fetch partial views, and so on. The starting point is the <strong>server.js</strong> file in the root directory where I bootstrap the server application by configuring Express and Passport and setting up other middleware components.</p>

<h2>Routing</h2>

<p>Before I actually start up the server in <strong>server.js</strong> I will register my own routes by calling the module defined in <strong>routes.js</strong>. Let’s take a closer look at it.</p>

<div><script src='https://gist.github.com/6116325.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>Since I want to set up my server-side routes somewhat similarly to how I did on the client-side, I create an array called routes which contains objects defining each route. This gives me the freedom to customize what kind of metadata I want to associate with each route. These are the properties I expect in a route object:</p>

<table>
<thead>
<tr>
<th>Property    </th>
<th> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>path</strong>        </td>
<td> The url you want the route to map to</td>
</tr>
<tr>
<td><strong>httpMethod</strong>  </td>
<td> HTTP Method, GET, POST, PUT, or DELETE</td>
</tr>
<tr>
<td><strong>middleware</strong>  </td>
<td> An array of functions which will be executed in the order left to right</td>
</tr>
<tr>
<td><strong>accessLevel</strong> </td>
<td> The access level of the route. If the user requesting the route doesn’t have access a 403 Unauthorized will be returned. If this property is not present, an access level of public is assumed.</td>
</tr>
</tbody>
</table>


<br />


<h2>Authorization</h2>

<p>One of the more interesting properties here is the <code>accessLevel</code> property, which is used to restrict access to the route for certain user roles. This property is not required unless you want to restrict access to a route for a certain set of users. As you might remember from <a href="http://www.frederiknakstad.com/authentication-in-single-page-applications-with-angular-js/">my previous post</a>, I made a module wherein I declared all user roles and access levels. I used a little trick to make this module usable both in the browser and by Node.js. This ensures that the values used to define access levels and user roles are equal on the server- and client-side. Of course the end-user can tamper with the values in his browser, but that won’t affect what’s running server-side. This is why I have been stressing the point that you need to make sure your server-side resources are properly secured. In case you forgot, here’s what the code looks like:</p>

<div><script src='https://gist.github.com/6031923.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>To enforce the access levels I’ve set on my routes I made a middleware component. This middleware component will calculate whether the current user has access to the requested route using a bitwise OR operation on the access level of the route and role of the requesting user. If the user is found to not have access the sever will respond with a HTTP 403, and break out of the middleware chain. You might also notice that I fall back on the respective <code>public</code> values for access levels and user roles by default if no user is logged in or if the route does not contain the accessLevel property.</p>

<div><script src='https://gist.github.com/6165691.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>So, now I need to register my routes with express and make sure that the <code>ensureAuthorized</code> middleware is run on all of them. I usually perform this logic in the function I export from the <strong>routes.js</strong> file, so that I can easily call it, and thus register my routes, from my <strong>server.js</strong> file. The function loops over the <code>routes</code> array, prepending each route’s middleware arrays with the <code>ensureAuthorized</code> component, and then registering it with express according to the other route metadata.</p>

<div><script src='https://gist.github.com/6150416.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>And that’s it! I want to remind that you can see a more comprehensive example in <a href="https://github.com/fnakstad/angular-client-side-auth">this Github repo</a>. If you want a better understanding of how this approach works, I highly recommend that you clone and mess around with it a little bit. And if you have any questions or issues, just post a comment here or an issue on Github.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/28/hello-octopress/">Hello Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-28T00:55:00+02:00" pubdate data-updated="true">Jul 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/28/hello-octopress/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been working on migrating my blog from Wordpress to Octopress lately, and finally the new version is live!
The new setup is running via <a href="http://nginx.org/">nginx</a> on an Ubuntu VPS from <a href="https://www.digitalocean.com/">DigitalOcean</a>.
This was my first time trying out nginx, and it was surprisingly simple to set up!
I guess it&rsquo;s used more often as a reverse proxy, but for static sites (such as Octopress) it also works really well as a simple server.</p>

<p>Another reason for the lack of posts lately is that I am moving to Tokyo this September to start studying at <a href="http://www.waseda.jp/">Waseda University</a>.
I&rsquo;ll be starting my Master&rsquo;s studies there as part of <a href="http://www.washi.cs.waseda.ac.jp/">Professor Washizaki&rsquo;s lab</a>, and I couldn&rsquo;t be more excited about it!
Needless to say, moving to the other side of the world encompasses a ton of preparations and paperwork (and the Japanese, like any other bureaucracy I guess, <em>love</em> their paperwork).</p>

<p>So, hopefully there will be more non-technical posts as well.
However, I have a half-finished post I&rsquo;ll publish quite soon, which will complement <a href="http://www.frederiknakstad.com/authentication-in-single-page-applications-with-angular-js/">Authentication in Single Page Applications With Angular.js</a> with information about how the server-side is set up. I&rsquo;ve received a lot of questions about that, so I thought a clarification might be in order.</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/3H7ditla3l4 "></iframe></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/application-cache-update-process-state-diagram/">Application Cache Update Process State Diagram</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-24T00:00:00+02:00" pubdate data-updated="true">May 24<span>th</span>, 2013</time>
        
         | <a href="/application-cache-update-process-state-diagram/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&rsquo;s a quick  little follow-up to my last post about the Application Cache. How the browser checks and fetches the cache can be a little confusing at first, so I made a state diagram to keep track of the different states the Application Cache might be in and the events that change said state.</p>

<p><img src="/images/posts/appCache_stateDiag.png"></p>

<p>Well, it&rsquo;s not awfully complicated, but it&rsquo;s nice to have a visual aid when debugging. The guard conditions indicate whether there already exists an old version of the application cache or not.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/awkward-change-flow-or-how-i-learned-to-stop-worrying-and-love-the-application-cache/">Awkward Change Flow or: How I Learned to Stop Worrying and Love the Application Cache</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-20T00:00:00+02:00" pubdate data-updated="true">May 20<span>th</span>, 2013</time>
        
         | <a href="/awkward-change-flow-or-how-i-learned-to-stop-worrying-and-love-the-application-cache/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Snappy title, yes&hellip;? Let&rsquo;s just move on&hellip;</p>

<p>The application cache API introduced by HTML5 is a very powerful tool which is particularly useful for web applications whose intended primary use is on mobile devices. Not only can it significantly speed up the load time of your app, but if implemented correctly you can make your application work quite well even when the user is not connected to the Internet. I&rsquo;m not going to write too much about how the application cache works as it has already been covered very well elsewhere. If that&rsquo;s what you&rsquo;re looking for I&rsquo;d recommend the following articles:</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/HTML/Using_the_application_cache">Mozilla Developer Network &ndash; Using the application cache</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/appcache/beginner">HTML5 Rocks &ndash; A Beginner&rsquo;s Guide to Using the Application Cache</a></li>
<li><a href="http://diveintohtml5.info/offline.html">Dive Into HTML5 &ndash; Let&rsquo;s Take This Offline</a></li>
<li><a href="http://www.w3.org/TR/offline-webapps">W3C&rsquo;s Offical Specification &ndash; Offline Web Applications</a></li>
</ul>


<p>These articles describe the API really well, and also notes several of the &ldquo;gotchas&rdquo; that might trip you up if you&rsquo;re not aware of them. If not taken into serious consideration these gotchas can make further development of your application turn into a painful and frustrating experience. So, I wanted to document a way of easing the pain.</p>

<h2>Automatically updating the cache manifest file when files change</h2>

<p>One of the more annoying quirks of developing with the application cache is that it has no mechanism for detecting updates to already cached resources. It doesn&rsquo;t re-cache any of the files in the manifest till the contents of the manifest itself has changed. The way most people get around this is by adding a comment to the top or bottom of the manifest with a timestamp or revision number. However, constantly updating this comment every time you want the browser to recache your resource will get tedious really quick.</p>

<p>So, we need a way of automatically updating this comment in the manifest whenever a change has been detected in one of our cached files! To do this I prefer to use <a href="http://gruntjs.com">Grunt</a>, which is a tool used to run automated tasks. It has a bunch of useful plugins, and for our purposes we need the <a href="https://github.com/gunta/grunt-manifest">grunt-manifest</a> and <a href="https://github.com/gruntjs/grunt-contrib-watch">grunt-contrib-watch</a> packages. <strong>grunt-manifest</strong> enables you to define your cache manifest configuration in your Gruntfile as a JSON object and regenerate on demand, while <strong>grunt-contrib-watch</strong> will run any task you specify when any of the files it&rsquo;s watching is updated&hellip; You can probably see where this is going&hellip;</p>

<p>To install all the necessary packages, just run the following commands in your project folder (assuming you already have installed npm):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install -g grunt-cli
</span><span class='line'>npm install grunt
</span><span class='line'>npm install grunt-manifest
</span><span class='line'>npm install grunt-contrib-watch</span></code></pre></td></tr></table></div></figure>


<p>Next, create a <code>Gruntfile.js</code> in your project root, which is where we will define our automated tasks:</p>

<div><script src='https://gist.github.com/6033441.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>Here we define two tasks, <code>manifest</code> and <code>watch</code>. The <code>manifest</code> task will generate a new manifest file and update the timestamp in the comment at the top of the file. The <code>watch</code> task will monitor the files specified, and is configured to perform the manifest task when a change has been detected. So, now we can have the manifest be automatically generated whenever a file changes by running the command <code>grunt watch</code>. This task can yet again be made part of a separate <code>run-dev</code> task which could also fire up a local node-server, live-reload, automatic LESS compilation, etc. to remove any other tasks you do manually when starting up a development server.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/seeding-mongodb-through-your-mongoose-models/">Seeding Mongodb Through Your Mongoose Models</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-12T00:00:00+02:00" pubdate data-updated="true">Apr 12<span>th</span>, 2013</time>
        
         | <a href="/seeding-mongodb-through-your-mongoose-models/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>23/4/2013 Update:</strong>
<em>A change implementing promise support for the</em> <code>create</code> <em>function <a href="https://github.com/LearnBoost/mongoose/commit/2ef5f237e054fc4846143530410e353ef7a7456e">was just committed to GitHub</a>, and should be available in the 3.7 release of Mongoose. Sweet!</em></p>

<p>Just wanted to share a nice little technique I discovered when working on a project using the wonderful <a href="http://mongoosejs.com/">Mongoose</a> library to interact with a MongoDB database in Node.js. I was writing some integration tests, and needed to reset and seed the database from a set of JSON files before running each test. I really wanted to do this through my existing Mongoose models, so that I could get all the seed data validated before running my tests. Since there also are relations between my different collections I needed to insert the collections in a certain order, so my first attempt quickly devolved into a textbook example of the good ol&#8217; pyramid of doom:</p>

<div><script src='https://gist.github.com/6033297.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>In the above code snippet <code>User</code>, <code>Exercise</code>, and <code>WorkoutTemplate</code> are my mongoose models, and since my <code>WorkoutTemplate</code> schema references my <code>Exercise</code> schema I need to insert data in that specific order. Using Mongoose&rsquo;s <code>remove</code> function with an empty object as the first argument will clear everything from the related collection. Furthermore, the <code>create</code> function will attempt to do a batch insert of the array you hand it. However, as you can see this quickly devolved into callback hell, and that was with just three different collections! Fortunately, I discovered that the <code>exec</code> function, which you can call on query objects, returns a promise object. This means I can just make a pretty, little promise chain instead of using callbacks.</p>

<p>There is just one obstacle to this&hellip; The <code>create</code> function does not return a query object, meaning we can&rsquo;t call <code>exec</code> on it to return a promise&hellip; I decided to rectify this by attaching a new function on the base mongoose Model which basically just wraps the <code>create</code> function, but actually returns a promise object.</p>

<div><script src='https://gist.github.com/6033333.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>So, finally I am able to create a nice and neat promise chain in the <code>beforeEach</code> function of my test suite. Voilà!</p>

<div><script src='https://gist.github.com/6033342.js'></script>
<noscript><pre><code></code></pre></noscript></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/psych-saturday/">Psych Saturday</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-26T00:00:00+01:00" pubdate data-updated="true">Jan 26<span>th</span>, 2013</time>
        
         | <a href="/psych-saturday/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve always been a huge fan of psychedelic and acid rock from the 60&rsquo;s, so I&rsquo;m really happy to see the resurgence of this type of music in more recent times. Some of the best albums to come out the past few years have come from bands like Deerhunter and Animal Collective who borrow heavily from the likes of Revolver-era Beatles and psych classic <a href="http://www.allmusic.com/album/the-united-states-of-america-mw0000207966">The United States of America</a>. The genre hasn&rsquo;t really changed that much with the new crop of bands popping up&hellip; They&rsquo;re basically doing the same thing they did in the 60&rsquo;s, but that still means there&rsquo;s a much greater willingness to experiment with structure and sound than you see elsewhere.</p>

<p>One band I&rsquo;ve taken a great liking to is Tame Impala from Perth, Australia. I remember being hooked as soon as I heard the opening track to <a href="http://www.allmusic.com/album/innerspeaker-mw0001990920">Innerspeaker</a> called <em>It Is Not Meant To Be</em>. The part that really stands out to me, and makes the song shine, is how the aural texture (for lack of a better term&hellip;) of the song shifts so perfectly to match the lyrics. The instrumentation is pretty standard, but it seems very thought out how the different instruments interact and carry each other through the different parts of the song. To me it&rsquo;s a perfect psych pearl, and my favorite Tame Impala song.</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/bUq3oc0lYbw "></iframe></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/authentication-in-single-page-applications-with-angular-js/">Authentication in Single Page Applications With Angular.js</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-21T00:00:00+01:00" pubdate data-updated="true">Jan 21<span>st</span>, 2013</time>
        
         | <a href="/authentication-in-single-page-applications-with-angular-js/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>3/6/2013 update:</strong>
<em>I&rsquo;ve done some heavy refactoring, and have now introduced an angular service to eliminate a lot of redundant code, as well as a directive which can aid in optionally displaying/hiding elements based on an access level. Please check out the <a href="https://github.com/fnakstad/angular-client-side-auth">GitHub repo</a> for the latest version. The example app in the repo has been deployed to Heroku, so now you can test it out live for yourself <a href="http://angular-client-side-auth.herokuapp.com/">right here</a>. A separate blogpost discussing the complementing server-side code <a href="http://www.frederiknakstad.com/blog/2013/08/04/authentication-in-single-page-applications-with-angular.js-part-2/">can be found here</a>.</em></p>

<p>I have been working a lot with Angular.js lately, and love how easy it makes it to create web applications with rich client-side functionality. It&rsquo;s an extremely useful asset in keeping your own client-side code lean, making it easy to separate business logic and declarative markup for anything view specific.  However, it&rsquo;s not all roses, and I&rsquo;m still struggling to find the best solutions to some problems I have encountered. One of which is a problem that exceeds the scope of Angular&hellip;</p>

<p><strong><em>How do I deal with authentication and authorization in single page applications?</em></strong></p>

<p>Since only the initial load of the app is a full page load, and subsequent communication with the server is entirely done via XHRs I need a slightly different model from the traditional one. One option I tried out was to have a traditional login page which, on success, redirects to a secured URL which loads the actual application. This has the added benefit that the client side code and view templates used for pages intended for logged in users are not accessible to anyone not logged in. However, in many cases this is not much of a concern as long as the communication against the resource API is properly secured. Preventing anyone from getting or modifying sensitive data is a server-side issue, and should therefore be properly handled there. I wanted a seamless user experience with no full page reloads beyond the initial page load, so I decided to play around a little and see if I could come up with an alternative. These are the core characteristics of the solution I set out to implement:</p>

<ol>
<li>The server needs to communicate what permissions/role the client has on inital page load.</li>
<li>The client app then needs to keep track of the user&rsquo;s login status, and change it accordingly when the user logs in or out. These operations should not cause a full page reload.</li>
<li>The access level of the routes should be declared as part of the rest of the routing configuration.</li>
</ol>


<h2>Configuring access levels and user roles</h2>

<p>To indicate the available user roles and access levels to be used in the routing system, I decided to make a separate module which could be used both on the client and server side (with Node.js):</p>

<div><script src='https://gist.github.com/6031923.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>Both the user roles and access levels are defined as numbers so that it is possible to calculate permissions using binary operations. User roles are defined by which bit is set to 1, while access levels indicate whether that user role has access by setting the corresponding bit to either 1 or 0 in the bitmask<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. So, here is an example of binary operations that can be calculated to see whether the user role <code>user</code> has access to the access levels <code>admin</code> and <code>public</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   010 // = userRole: user
</span><span class='line'>OR 100 // = accessLevel admin
</span><span class='line'>=  000 // = false, no access
</span><span class='line'>
</span><span class='line'>   010 // = userRole: user
</span><span class='line'>OR 111 // = accessLevel public
</span><span class='line'>=  010 // = true, go ahead</span></code></pre></td></tr></table></div></figure>


<h2>Setting up client-side routing</h2>

<p>When I define my routes I want to indicate what access level each route should have, so I add a new property to each route, called <code>access</code>, like so:</p>

<div><script src='https://gist.github.com/6032777.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<h2>Communicating login status to client side app on initial page load</h2>

<p>When the user first loads the client side app, whether he&rsquo;s trying to access a restricted or public route initially, the server needs to communicate the current role of the user. Since the client side app can&rsquo;t decrypt the authentication cookie set by the server, I decided to communicate login status via the HTTP response which serves up the single page application. I decided on doing this by setting a cookie, which the client would clear upon reading it. I feel like there&rsquo;s something icky about doing it this way, so I&rsquo;m open to any alternative solutions here. Anyway, the server sets the cookie like so:</p>

<div><script src='https://gist.github.com/6032803.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>On the client-side I have an Angular service, <code>Auth</code>, which upon initialization will read in this cookie, save the login status, then discard the cookie. This service will also make the access levels, user roles, and current user available to the rest of the application.</p>

<div><script src='https://gist.github.com/6032854.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>So, now my Angular app knows what login status the user has, and can perform the client side routing based on this status.</p>

<h2>Enforcing the routing policy client-side</h2>

<p><strong>Warning: I want to stress the importance of securing your server-side API once-again. The routing policy we&rsquo;re &ldquo;enforcing&rdquo; client-side is <em>very</em> easy to get around using Chrome Developer Tools or Firebug. The technique I&rsquo;m describing is used as a way of tailoring your views and giving a better user experience, but malicious users can still change their user role and get access to client-side routes that should be restricted to them. This is not a problem as long as any sensitive data is accessed via your server-side API, and the proper authentication/authorization strategy is implemented there.</strong></p>

<p>Now that I have access to the current user&rsquo;s role and the access level of each route I can actually enforce the policy I&rsquo;ve configured. So now I can add functionality like logging in, registering new users, authorizing a route, etc. to the <code>Auth</code> service I mentioned earlier.</p>

<div><script src='https://gist.github.com/6032902.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>This service can easily be reused by injecting it into any other component of my Angular application. For example, to actually enforce my routing policy I need to utilize the <code>authorize()</code> and <code>isLoggedIn()</code> functions in an event handler on $routeChangeStart:</p>

<div><script src='https://gist.github.com/6032970.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>Now, whenever a route is accessed, the proper authorization check will be performed before serving up the view, and a redirect will happen in case the user has insufficient permissions.</p>

<p>One gotcha here is that the session could time out making the client believe the user is logged in when in fact he is declined when communicating with the server resource API. However this can be rectified by using an HTTP interceptor to detect API calls that were denied. Mine is pretty simple, and just redirects to the login page in case of a 401.</p>

<div><script src='https://gist.github.com/6033015.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<h2>Customizing views based on user role</h2>

<p>I also want to introduce a directive I&rsquo;ve made which you can use to show/hide elements based on the current user&rsquo;s role. Here&rsquo;s what it looks like:</p>

<div><script src='https://gist.github.com/6033059.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>So, whenever you decorate a tag with the <code>access-level</code> directive, it will check the role of the current user, perform an authorization check using the injected <code>Auth</code>, and then show/hide the element. It also remembers the previous <code>display</code> property of the element in case the user logs out, thus changing her role.</p>

<p>I really want to stress again the point that this scheme exposes all the routing logic and view templates to the client, and can easily be manipulated by the end user. So, you still have to make sure that the calls to the server are properly authenticated and authorized there.</p>

<p>I have made a complete example with all the code available in <em><a href="https://github.com/fnakstad/angular-client-side-auth">this GitHub repository</a></em>, which might illustrate my approach better than I have been able to in this blogpost.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>The routingConfig module in the <a href="https://github.com/fnakstad/angular-client-side-auth">GitHub repo</a> will now automatically generate the required bit masks for you!<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/the-solar-system">The Solar System</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-23T00:00:00+01:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2012</time>
        
         | <a href="/the-solar-system#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While reading a Japanese text today, I ran into a sentence mentioning the planet Venus. In Japanese Venus is known as <ruby>金星<rt>きんせい</rt></ruby>, the kanji meaning &ldquo;gold/metal&rdquo; and &ldquo;star&rdquo; respectively. I decided to check out the other planet names of our solar system, and found out that they follow a naming pattern very close to how Japanese week days are named.   Just like the Japanese weekdays, many of the planets in our solar system are associated with an element like water, fire, and so on. Just see for yourself:</p>

<table>
<thead>
<tr>
<th align="center"><ruby>日本語<rt>にほんご</rt></ruby> </th>
<th align="center"> English</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><ruby>太陽<rt>たいよう</rt></ruby>        </td>
<td align="center"> Sun</td>
</tr>
<tr>
<td align="center"><ruby>水星<rt>すいせい</rt></ruby>    </td>
<td align="center"> Mercury</td>
</tr>
<tr>
<td align="center"><ruby>金星<rt>きんせい</rt></ruby>    </td>
<td align="center"> Venus</td>
</tr>
<tr>
<td align="center"><ruby>地球<rt>ちきゅう</rt></ruby>    </td>
<td align="center"> Earth</td>
</tr>
<tr>
<td align="center"><ruby>火星<rt>かせい</rt></ruby>       </td>
<td align="center"> Mars</td>
</tr>
<tr>
<td align="center"><ruby>木星<rt>もくせい</rt></ruby>    </td>
<td align="center"> Jupiter</td>
</tr>
<tr>
<td align="center"><ruby>土星<rt>どせい</rt></ruby>       </td>
<td align="center"> Saturn</td>
</tr>
<tr>
<td align="center"><ruby>天王星<rt>てんのうせい</rt></ruby>   </td>
<td align="center"> Uranus</td>
</tr>
<tr>
<td align="center"><ruby>海王星<rt>かいおうせい</rt></ruby>   </td>
<td align="center"> Neptune</td>
</tr>
</tbody>
</table>


<p>So, if you disregard the sun and earth all but two of the planets are associated with an element. The origin for this naming scheme, I found out, is the concept of <a href="http://en.wikipedia.org/wiki/Wu_Xing">Wu Xing</a> which is prevalent in several Eastern Asian cultures. Wu Xing is a system for dividing different natural phenomena into five different phases corresponding to what the Chinese thought to be the five basic elements of nature: wood, fire, earth, metal, and water. This system was used to describe anything from cosmic cycles to musical notation and anatomical  processes. Thus, according to this system, Mercury is associated with water (水), Venus with gold/metal (金), Mars with fire (火), Jupiter with wood (木), and Saturn with earth (土).</p>

<p>However, that means there are no elements left to assign to Uranus and Neptune&hellip; Since these two planets were discovered relatively recently, their names are simply translations from their Roman and Greek counterparts. Since Uranus was the Greek god of the sky, they decided to use the characters 天 and 王 in its name, meaning &ldquo;heaven&rdquo; and &ldquo;king&rdquo; respectively. Neptune, also known as the Roman god of the sea, was named using 海 and 王, meaning &ldquo;sea&rdquo; and &ldquo;king&rdquo;.</p>

<p>Knowing the history behind the names should be really helpful in memorizing them! In concluding this post, I&rsquo;d like to list some other astronomical terms I came across:</p>

<table>
<thead>
<tr>
<th align="center"><ruby>日本語<rt>にほんご</rt></ruby> </th>
<th align="center"> English</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><ruby>月<rt>つき</rt></ruby>     </td>
<td align="center"> Moon</td>
</tr>
<tr>
<td align="center"><ruby>惑星<rt>わくせい</rt></ruby>    </td>
<td align="center"> Planet</td>
</tr>
<tr>
<td align="center"><ruby>星<rt>ほし</rt></ruby>     </td>
<td align="center"> Star</td>
</tr>
<tr>
<td align="center"><ruby>太陽系<rt>たいようけい</rt></ruby>   </td>
<td align="center"> Solar system</td>
</tr>
<tr>
<td align="center"><ruby>銀河系<rt>ぎんがけい</rt></ruby>  </td>
<td align="center"> Galaxy</td>
</tr>
<tr>
<td align="center"><ruby>小惑星<rt>しょうわくせい</rt></ruby>    </td>
<td align="center"> Asteroid</td>
</tr>
<tr>
<td align="center"><ruby>小惑星帯<rt>しょうわくせいたい</rt></ruby>       </td>
<td align="center"> Asteroid belt</td>
</tr>
<tr>
<td align="center"><ruby>彗星<rt>すいせい</rt></ruby>    </td>
<td align="center"> Comet</td>
</tr>
<tr>
<td align="center"><ruby>流星<rt>りゅうせい</rt></ruby>     </td>
<td align="center"> Meteor</td>
</tr>
<tr>
<td align="center"><ruby>隕石<rt>いんせき</rt></ruby>    </td>
<td align="center"> Meteorite</td>
</tr>
</tbody>
</table>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/dave-brubeck/">Dave Brubeck</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-06T00:00:00+01:00" pubdate data-updated="true">Dec 6<span>th</span>, 2012</time>
        
         | <a href="/dave-brubeck/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Dave Brubeck has passed away, and I felt compelled to share a few thoughts about the man and his music. I first heard about him when a friend of mine in Tennessee played some songs off the album Take Five for me. I had heard the song the album takes its name from before and associated with a Norwegian commercial for caf   cookies, so I wasn&rsquo;t too thrilled about it. However, after hearing the song in its entirety and enjoying the excellent solo performances of Paul Desmond and Joe Morello I could tell there was something more to it than the pickled and processed 20 second cut I had heard earlier. One of my absolute favorite drum solos ever has been performed as part of this song:</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/tsKq3HD0EFc "></iframe></div>


<p>Blue Rondo al   Turk was more of an immediate revelation the first time I heard it, and really shows off Brubeck&rsquo;s own chops. It&rsquo;s probably the second most famous song off of the album, and for good reason. It, like Take Five, has an immediately recognizable melody, but manages at the same time to be interesting enough for repeated listens. I&rsquo;ll leave you with a slightly less known track off the album, which really embodies the honesty and playful tone I love about his music. Rest in peace, Dave. You had a good run.</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/4Ro8-NOiMBY "></iframe></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/05/token-introductory-post/">Token Introductory Post</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-05T00:00:00+01:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/12/05/token-introductory-post/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><hr />

<p>layout: post
title: Token introductory post
status: publish
type: post
published: true
comments: true
permalink: /token-introductory-post/</p>

<p>I debated with myself for a little bit whether to have an introductory post or just to get started blogging. You can probably guess what I decided on in the end&hellip;</p>

<p>The purpose of this blog is completely for self-amusement, and is basically a means of jotting down notes for whatever it is I&rsquo;m working on at the   time. In the best case scenario other people will benefit from my posts, and give me feedback on better ways to solve things or simply provide interesting ideas and insight. I don&rsquo;t anticipate a huge flood of people wanting to read my ill-organized thoughts, but maybe I can distract the occasional straggler.</p>

<p>I&rsquo;ve been working a lot with Node.js, Angular, and MongoDB lately, and I&rsquo;m trying to find patterns and practices that can be reused. I will try to make some blog posts documenting whatever results I stumble upon and supplement with code examples on GitHub. I am also in the middle of studying the Japanese language so expect posts which basically are extended notes on the usage of various grammatical constructs, interesting kanji, words, and the occasional cultural revelation.</p>

<p>As stated earlier, this is a personal blog, so don&rsquo;t expect a very focused theme here; I will post about anything from cute kitty pictures to development patterns and books/music that interest me at the time. Blogging seems to me to have the potential to be a highly masturbatory and scatter-brained act, and I plan to indulge without any pretense of a more noble motive.</p>

<p>Anyway, stay tuned for actual content!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/04/authentication-in-single-page-applications-with-angular.js-part-2/">Authentication in Single Page Applications With Angular.js Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/28/hello-octopress/">Hello Octopress</a>
      </li>
    
      <li class="post">
        <a href="/application-cache-update-process-state-diagram/">Application Cache Update Process State Diagram</a>
      </li>
    
      <li class="post">
        <a href="/awkward-change-flow-or-how-i-learned-to-stop-worrying-and-love-the-application-cache/">Awkward Change Flow or: How I Learned to Stop Worrying and Love the Application Cache</a>
      </li>
    
      <li class="post">
        <a href="/seeding-mongodb-through-your-mongoose-models/">Seeding Mongodb Through Your Mongoose Models</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Frederik Nakstad
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'amodestproposal';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
